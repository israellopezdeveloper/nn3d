name: CI Main Branch

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  publish-npm:
    name: Generate and push images
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        recursive: true
          
    - name: Setup Node (latest LTS)
      uses: actions/setup-node@v4
      with:
        node-version: "lts/*"
        registry-url: "https://registry.npmjs.org"

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Build
      run: pnpm build

    - name: Pack (sanity check)
      run: pnpm prepack

    - name: Publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: npm publish --access public

  build-and-deploy-demo:
    runs-on: ubuntu-latest
    needs: publish-npm
    steps:
      - name: Checkout main (to read tag)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version + repo name
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"          # e.g. v1.2.3
          VER="${TAG#v}"                    # 1.2.3
          REPO="${GITHUB_REPOSITORY##*/}"   # repo name
          echo "ver=$VER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages branch into ./ghp
        run: |
          git fetch origin gh-pages:gh-pages
          git worktree add ghp gh-pages

      - name: Setup Node (latest LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Update demo dependency to released version
        working-directory: ghp/demo
        env:
          VERSION: ${{ steps.meta.outputs.ver }}
          PKG_NAME: "@israellopezdeveloper/nn3d"
        run: |
          pnpm pkg set "dependencies.${PKG_NAME}=${VERSION}"

      - name: Install demo deps
        working-directory: ghp/demo
        run: pnpm install --no-frozen-lockfile

      - name: Build demo (static for GitHub Pages)
        working-directory: ghp/demo
        env:
          BASE_PATH: /${{ steps.meta.outputs.repo }}
        run: pnpm build

      - name: Publish build output to gh-pages root (keeping demo/)
        run: |
          # Limpia el root del branch gh-pages excepto la carpeta demo y .git
          shopt -s dotglob
          for item in ghp/*; do
            base="$(basename "$item")"
            if [ "$base" != "demo" ] && [ "$base" != ".git" ]; then
              rm -rf "$item"
            fi
          done

          # Copia el build del demo al root del branch
          cp -R ghp/demo/build/* ghp/

      - name: Commit & push gh-pages
        working-directory: ghp
        env:
          VERSION: ${{ steps.meta.outputs.ver }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update demo for v${VERSION}" || echo "No changes to commit"
          git push origin HEAD:gh-pages
